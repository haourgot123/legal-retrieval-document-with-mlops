---
repositories:
  - name: elastic
    url: https://helm.elastic.co

releases:
  - name: elk-elasticsearch
    namespace: elk
    chart: elastic/elasticsearch
    version: 7.17.3
    values:
      - ./elastic.expanded.yaml

  - name: elk-kibana
    namespace: elk
    chart: elastic/kibana
    version: 7.17.3
    values:
      - ./kibana.expanded.yaml
    needs:
      - elk/elk-elasticsearch

  - name: elk-logstash
    namespace: elk
    chart: elastic/logstash
    version: 7.17.3
    values:
      - ./logstash.expanded.yaml
    needs:
      - elk/elk-elasticsearch

  - name: elk-filebeat
    namespace: elk
    chart: elastic/filebeat
    version: 7.17.3
    values:
      - ./filebeat.expanded.yaml
    needs:
      - elk/elk-logstash

# Hooks to create namespace and secrets
hooks:
  - events: ["presync"]
    showlogs: true
    command: "kubectl"
    args:
      - create
      - namespace
      - elk
      - --dry-run=client
      - -o=yaml
      - "|"
      - kubectl
      - apply
      - -f
      - -

  - events: ["presync"]
    showlogs: true
    command: "sh"
    args:
      - -c
      - |
        kubectl create secret generic logstash-elasticsearch-credentials \
          --from-literal=username=elastic \
          --from-literal=password=$(kubectl get secrets --namespace=elk elasticsearch-master-credentials -ojsonpath='{.data.password}' | base64 -d) \
          --namespace=elk \
          --dry-run=client -o yaml | kubectl apply -f -
